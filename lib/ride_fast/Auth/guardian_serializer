defmodule RideFast.Auth.GuardianSerializer do
  @behaviour Guardian.Serializer
  alias RideFast.Accounts


  def resource_from_claims(%{"typ" => "user", "sub" => id} = _claims) do
    case Accounts.get_user(id) do
      nil -> {:error, :user_not_found}
      user -> {:ok, user}
    end
  end

  def resource_from_claims(%{"typ" => "driver", "sub" => id} = _claims) do
    case Accounts.get_driver(id) do
      nil -> {:error, :driver_not_found}
      driver -> {:ok, driver}
    end
  end

  def resource_from_claims(_claims), do: {:error, :unauthorized}

  def serialize_for_token(%{id: id} = resource) do
    type =
      cond do
        is_struct(resource, Accounts.User) -> "user"
        is_struct(resource, Accounts.Driver) -> "driver"
        true -> "unknown"
      end

    {:ok, to_string(id), %{typ: type}}
  end

  def serialize_for_token(_), do: {:error, :invalid_resource}
end
